name: Build Deep-Live-Cam AppImage

on:
  workflow_dispatch:
    inputs:
      include_models:
        description: 'Include ML models in AppImage (larger but works offline)'
        required: true
        default: 'true'
        type: boolean
      cuda_support:
        description: 'Include CUDA support for Nvidia GPUs'
        required: true
        default: 'true'
        type: boolean

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          df -h

      - name: Checkout Deep-Live-Cam
        uses: actions/checkout@v4
        with:
          repository: hacksider/Deep-Live-Cam
          ref: main

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ffmpeg \
            libgl1-mesa-glx \
            libglib2.0-0 \
            libsm6 \
            libxext6 \
            libxrender-dev \
            libfontconfig1 \
            python3-tk \
            fuse \
            libfuse2

      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          # Install without CUDA first (smaller)
          pip install numpy opencv-python pillow psutil tk customtkinter
          pip install onnx onnxruntime insightface
          pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu
          pip install tensorflow-cpu
          pip install protobuf==4.25.1
          pip install opennsfw2
          # Install from git
          pip install git+https://github.com/xinntao/BasicSR.git@master
          pip install git+https://github.com/TencentARC/GFPGAN.git@master
          pip install pyinstaller

      - name: Install CUDA dependencies
        if: ${{ inputs.cuda_support }}
        run: |
          pip uninstall -y torch torchvision onnxruntime
          pip install torch torchvision --index-url https://download.pytorch.org/whl/cu128
          pip install onnxruntime-gpu==1.21.0

      - name: Download models
        if: ${{ inputs.include_models }}
        run: |
          mkdir -p models
          wget -q --show-progress -P models \
            https://huggingface.co/hacksider/deep-live-cam/resolve/main/GFPGANv1.4.pth
          wget -q --show-progress -P models \
            https://huggingface.co/hacksider/deep-live-cam/resolve/main/inswapper_128_fp16.onnx

      - name: Create models placeholder
        if: ${{ !inputs.include_models }}
        run: |
          mkdir -p models
          cat > models/README.txt << 'EOF'
          Download these models and place them here:
          - https://huggingface.co/hacksider/deep-live-cam/resolve/main/GFPGANv1.4.pth
          - https://huggingface.co/hacksider/deep-live-cam/resolve/main/inswapper_128_fp16.onnx
          EOF

      - name: Build with PyInstaller
        run: |
          pyinstaller \
            --onedir \
            --name deep-live-cam \
            --add-data "models:models" \
            --add-data "modules:modules" \
            --hidden-import=cv2 \
            --hidden-import=onnxruntime \
            --hidden-import=insightface \
            --hidden-import=gfpgan \
            --hidden-import=basicsr \
            --hidden-import=customtkinter \
            --hidden-import=tkinter \
            --hidden-import=PIL \
            --collect-all customtkinter \
            --collect-all insightface \
            --collect-all gfpgan \
            --collect-all basicsr \
            run.py

      - name: Download appimagetool
        run: |
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

      - name: Create AppImage structure
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          
          # Copy PyInstaller output
          cp -r dist/deep-live-cam/* AppDir/usr/bin/
          
          # Create desktop entry
          cat > AppDir/deep-live-cam.desktop << 'EOF'
          [Desktop Entry]
          Name=Deep Live Cam
          Comment=Real-time face swap and deepfake
          Exec=deep-live-cam
          Icon=deep-live-cam
          Type=Application
          Categories=Graphics;Video;
          Terminal=false
          EOF
          
          # Create a simple icon (placeholder)
          cat > AppDir/usr/share/icons/hicolor/256x256/apps/deep-live-cam.svg << 'EOF'
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
            <circle cx="50" cy="50" r="45" fill="#6366f1"/>
            <circle cx="35" cy="40" r="8" fill="white"/>
            <circle cx="65" cy="40" r="8" fill="white"/>
            <path d="M30 65 Q50 80 70 65" stroke="white" stroke-width="4" fill="none"/>
          </svg>
          EOF
          
          # Copy icon to root for AppImage
          cp AppDir/usr/share/icons/hicolor/256x256/apps/deep-live-cam.svg AppDir/
          cp AppDir/deep-live-cam.desktop AppDir/
          
          # Create AppRun script
          cat > AppDir/AppRun << 'EOF'
          #!/bin/bash
          APPDIR="$(dirname "$(readlink -f "$0")")"
          export PATH="$APPDIR/usr/bin:$PATH"
          export LD_LIBRARY_PATH="$APPDIR/usr/bin:$LD_LIBRARY_PATH"
          export TCL_LIBRARY="$APPDIR/usr/bin/tcl"
          export TK_LIBRARY="$APPDIR/usr/bin/tk"
          cd "$APPDIR/usr/bin"
          exec "$APPDIR/usr/bin/deep-live-cam" "$@"
          EOF
          chmod +x AppDir/AppRun

      - name: Build AppImage
        run: |
          ARCH=x86_64 ./appimagetool-x86_64.AppImage --no-appstream AppDir
          
          # Rename with version info
          SUFFIX=""
          if [ "${{ inputs.cuda_support }}" = "true" ]; then
            SUFFIX="-cuda"
          fi
          if [ "${{ inputs.include_models }}" = "false" ]; then
            SUFFIX="${SUFFIX}-no-models"
          fi
          mv Deep_Live_Cam*.AppImage "Deep-Live-Cam${SUFFIX}-x86_64.AppImage"

      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: Deep-Live-Cam-AppImage
          path: Deep-Live-Cam*.AppImage
